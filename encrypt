#!/bin/bash

function get_pwd {
    read -p "password: " -s PASSWORD
    echo
    read -p "again:" -s AGAIN
    if [ "$PASSWORD" != "$AGAIN" ];then
        echo "Passwords do not match, doing nothing"
        exit
    fi
    echo -e "\npasswords match"
}

function encrypt {
    INPUT=$1
    OUTPUT="$INPUT.encrypt"
    MSG=$(cat $INPUT | openssl enc -e -bf -a -salt -pass pass:$PASSWORD)
    MSG=$(echo $MSG | openssl enc -e -rc5-cbc -a -salt -pass pass:$PASSWORD)
    MSG=$(echo $MSG | openssl enc -e -aes-256-cbc -a -salt -pass pass:$PASSWORD)
    echo $MSG | openssl enc -e -des -a -salt -pass pass:$PASSWORD -out $OUTPUT
    if [ $? -eq 0 ];then
        rm "$INPUT"
    fi
    INPUT=""
    OUTPUT=""
}


function decrypt {
    INPUT=$1
    OUTPUT=$(echo $INPUT | sed 's/.encrypt//')
    MSG=$(openssl enc -d -des -a -salt -pass pass:$PASSWORD -in $INPUT)
    MSG=$(echo $MSG | openssl enc -d -aes-256-cbc -a -salt -pass pass:$PASSWORD)
    MSG=$(echo $MSG | openssl enc -d -rc5-cbc -a -salt -pass pass:$PASSWORD)
    MSG=$(echo $MSG | openssl enc -d -bf -a -salt -pass pass:$PASSWORD)
    if [ $? -eq 0 ];then
        echo "$MSG" > $OUTPUT 
        rm $INPUT
    fi
    INPUT=""
    OUTPUT=""
}

if [ $# -ne 2 ];then
    echo -e "\nUsage: encrypt <lock/unlock> <dir>\n"
    exit
fi
if [ "$1" == "lock" ];then
    echo "locking $2"
    get_pwd
    for FILE in `find $2 -type f`;do
        echo "$FILE"
        encrypt $FILE
    done
elif [ "$1" == "unlock" ];then
    echo "unlocking $2"
    get_pwd
    for FILE in `find $2 -type f`;do
        echo "$FILE"
        decrypt "$FILE"
    done
else
    echo -e "\n$1 not in [ lock,unlock ]\n"
fi
